# Qchatroom 开发文档

## 客户端

### 页面设计

#### 服务器连接页面

系统启动后首先显示服务器连接页面，用户需要在此页面输入服务器信息以建立连接：

- **服务器设置区域**：

  - 服务器 IP 地址输入框：支持 IPv4 格式地址输入
  - 服务器端口号输入框：支持端口号输入
  - 连接按钮：点击后尝试连接服务器
  - 连接状态提示：显示当前连接状态和错误信息

- **界面设计**：
  - 简单明了的布局，突出输入区域
  - 服务器连接成功后自动跳转至登录页面
  - 支持默认配置（本地测试用）

#### 登录/注册页面

登录页面是用户进入系统的入口，设计简洁明了，包含以下元素：

- **登录区域**：

  - 用户名输入框：接受字母、数字组合的用户名
  - 密码输入框：支持密码掩码显示，确保安全性
  - 登录按钮：点击后验证用户信息并登录系统
  - 注册链接：引导新用户进入注册界面
  - 服务器信息显示：显示当前连接的服务器地址和连接状态
  - 修改服务器配置按钮：允许用户重新配置服务器信息

- **注册区域**：

  - 用户名输入框：设置唯一用户名，系统会检查是否可用
  - 密码输入框：设置账户密码
  - 确认密码输入框：确保密码输入正确
  - 注册按钮：完成账户创建
  - 返回登录链接：返回登录界面

- **界面风格**：
  - 采用 Qt 的现代风格，简洁大方
  - 响应式设计，适应不同分辨率
  - 错误提示功能，对输入错误给予友好提示

#### 主界面设计

主界面是用户登录后的核心界面，采用分区域设计：

- **顶部区域**：

  - 系统名称
  - 用户信息显示（用户名和在线状态）
  - 功能导航栏（BBS、聊天、个人资料等）
  - 系统通知图标

- **中心内容区**：

  - 采用选项卡设计，可在 BBS 和聊天功能间切换
  - 每个选项卡有独立的功能区域和工具栏
  - 支持自适应布局

- **底部状态栏**：

  - 显示当前在线用户数
  - 系统状态信息
  - 版权和版本信息

- **界面交互**：
  - 拖拽调整区域大小

#### 个人资料页面

个人资料页面允许用户查看和管理自己的账户信息：

- **用户信息区**：

  - 用户名显示（不可修改，作为唯一标识）
  - 密码修改功能
  - 账户创建时间显示
  - 最后登录时间显示

- **数据统计区**：

  - 发帖数量统计
  - 回帖数量统计
  - 文件上传统计

- **操作区**：
  - 保存修改按钮
  - 返回主界面按钮

#### BBS 区域设计

BBS 区域是用户发布和浏览帖子的地方：

- **帖子列表区**：

  - 帖子标题列表，显示最新帖子
  - 每个帖子条目显示标题、发帖人、发帖时间、回复数
  - 分页导航，支持翻页查看更多帖子
  - 搜索功能，支持按标题关键词搜索

- **发帖区**：

  - 帖子标题输入框
  - 帖子内容编辑器，支持基本文本格式化
  - 文件上传按钮
  - 发布按钮

- **帖子详情区**：
  - 帖子完整内容显示
  - 帖子附件下载功能
  - 回帖列表，按时间顺序排列
  - 回帖编辑器，支持快速回复

#### 即时通讯区域设计

即时通讯区域用于用户之间的实时交流：

- **联系人列表**：

  - 显示所有好友用户
  - 用户在线状态指示
  - 最近联系人快速访问
  - 搜索功能

- **好友管理功能**：

  - 添加好友：通过用户名搜索和添加好友
  - 好友请求：显示收到的好友请求，可接受或拒绝
  - 好友删除：移除不再需要的好友关系

- **聊天窗口**：

  - 消息显示区域，支持文本和文件消息
  - 消息输入框，支持基本文本输入
  - 文件发送按钮，支持文件传输
  - 发送按钮和表情选择器

- **群聊功能**：
  - 群聊频道列表
  - 群成员列表
  - 群聊消息显示，区分不同发送者
  - 创建群聊：可选择好友创建新的群聊
  - 群组管理：添加/移除成员，设置群名称

### 功能模块

#### 用户模块

- 登录
- 注册
- 个人资料管理

#### BBS 模块

- 发帖
- 回帖
- 文件上传下载

#### 即时通讯模块

- 群聊实现
- 私聊实现
- 文件传输

### 网络通信

#### 与服务器连接

客户端与服务器的连接采用 Socket 通信方式，基于 Qt 的网络类实现：

- **连接建立**：

  - 使用 `QTcpSocket` 创建与服务器的连接
  - 连接参数包括服务器 IP 地址和端口号（用户在启动时输入）
  - 连接状态实时监控与显示

- **连接过程**：

  1. 应用启动时显示服务器配置页面
  2. 用户输入服务器 IP 和端口号并点击连接
  3. 系统尝试与服务器建立 TCP 连接
  4. 连接成功后保存配置并跳转至登录页面
  5. 登录验证成功后建立持久连接
  6. 连接建立后保持心跳包机制
  7. 应用关闭时正常断开连接

- **安全措施**：
  - 登录信息加密传输
  - 连接超时检测与处理

#### 数据传输格式

系统采用 JSON 格式作为数据交换格式，使用统一的消息结构：

- **消息基本结构**：

  ```json
  {
    "msgType": "类型标识",
    "timestamp": "时间戳",
    "data": {
      // 具体的消息内容，根据消息类型不同而变化
    }
  }
  ```

- **常见消息类型**：

  1. 连接相关消息
     - `connect_request`：服务器连接请求
     - `connect_response`：服务器连接响应
     - `heartbeat`：心跳包
  2. 用户认证消息
     - `login_request`：登录请求
     - `login_response`：登录响应
     - `register_request`：注册请求
     - `register_response`：注册响应
  3. BBS 相关消息
     - `post_list_request`：获取帖子列表
     - `post_detail_request`：获取帖子详情
     - `post_create`：创建新帖子
     - `reply_create`：创建回复
  4. 聊天相关消息
     - `chat_message`：聊天消息
     - `file_transfer`：文件传输消息
     - `group_message`：群聊消息

- **数据处理流程**：
  1. 客户端/服务端构造符合规范的 JSON 消息
  2. 使用 `QJsonDocument` 序列化消息
  3. 通过 TCP 套接字发送序列化后的消息
  4. 接收方接收并使用 `QJsonDocument` 反序列化消息
  5. 根据 `msgType` 字段决定如何处理消息内容
  6. 处理完成后构造响应消息并返回

#### 断线重连机制

为确保通信的可靠性，系统实现了完善的断线重连机制：

- **连接监控**：

  - 定期发送心跳包检测连接状态（每 30 秒一次）
  - 监听网络状态变化（使用 QNetworkConfigurationManager）
  - 设置连接超时阈值（默认 5 秒）

- **断线检测方法**：

  - 心跳包响应超时
  - Socket 错误事件处理
  - 服务器主动断开连接信号

- **用户体验优化**：
  - 断线期间的消息本地缓存
  - 重连过程状态提示
  - 手动重连按钮
  - 重连成功/失败通知

## 服务端

### 数据库设计

#### 用户表设计

用户表（Users）用于存储系统中所有用户的基本信息：

| 字段名      | 数据类型     | 约束             | 说明                    |
| ----------- | ------------ | ---------------- | ----------------------- |
| user_id     | INTEGER      | PRIMARY KEY      | 用户唯一标识符          |
| username    | VARCHAR(50)  | NOT NULL, UNIQUE | 用户名（系统内唯一）    |
| password    | VARCHAR(128) | NOT NULL         | 密码（加密存储）        |
| create_time | TIMESTAMP    | NOT NULL         | 账号创建时间            |
| last_login  | TIMESTAMP    |                  | 最后登录时间            |
| status      | TINYINT      | DEFAULT 0        | 用户状态(0-离线,1-在线) |

#### 群组表设计

群组表（Groups）用于存储聊天群组的基本信息：

| 字段名       | 数据类型     | 约束        | 说明                    |
| ------------ | ------------ | ----------- | ----------------------- |
| group_id     | INTEGER      | PRIMARY KEY | 群组唯一标识符          |
| group_name   | VARCHAR(100) | NOT NULL    | 群组名称                |
| creator_id   | INTEGER      | FOREIGN KEY | 创建者用户 ID           |
| create_time  | TIMESTAMP    | NOT NULL    | 创建时间                |
| member_count | INTEGER      | DEFAULT 1   | 成员数量                |
| status       | TINYINT      | DEFAULT 1   | 群组状态(0-解散,1-正常) |

#### 群组成员表设计

群组成员表（GroupMembers）用于存储群组成员关系：

| 字段名    | 数据类型  | 约束        | 说明                             |
| --------- | --------- | ----------- | -------------------------------- |
| id        | INTEGER   | PRIMARY KEY | 记录唯一标识符                   |
| group_id  | INTEGER   | FOREIGN KEY | 群组 ID                          |
| user_id   | INTEGER   | FOREIGN KEY | 用户 ID                          |
| join_time | TIMESTAMP | NOT NULL    | 加入时间                         |
| role      | TINYINT   | DEFAULT 0   | 角色(0-普通成员,1-管理员,2-群主) |
| status    | TINYINT   | DEFAULT 1   | 状态(0-已退出,1-正常)            |

#### 帖子表设计

帖子表（Posts）用于存储 BBS 系统中的所有帖子信息：

| 字段名       | 数据类型     | 约束        | 说明                    |
| ------------ | ------------ | ----------- | ----------------------- |
| post_id      | INTEGER      | PRIMARY KEY | 帖子唯一标识符          |
| title        | VARCHAR(100) | NOT NULL    | 帖子标题                |
| content      | TEXT         | NOT NULL    | 帖子内容(文本形式)      |
| content_type | TINYINT      | DEFAULT 1   | 内容类型(1-文本,2-文件) |
| file_id      | INTEGER      |             | 关联文件 ID(如果是文件) |
| user_id      | INTEGER      | FOREIGN KEY | 发帖用户 ID             |
| create_time  | TIMESTAMP    | NOT NULL    | 发帖时间                |
| update_time  | TIMESTAMP    |             | 最后更新时间            |
| reply_count  | INTEGER      | DEFAULT 0   | 回复数量                |
| status       | TINYINT      | DEFAULT 1   | 帖子状态(0-隐藏,1-显示) |

#### 消息表设计

消息表（Messages）用于存储用户之间的即时通讯消息：

| 字段名       | 数据类型  | 约束        | 说明                        |
| ------------ | --------- | ----------- | --------------------------- |
| message_id   | INTEGER   | PRIMARY KEY | 消息唯一标识符              |
| sender_id    | INTEGER   | FOREIGN KEY | 发送者用户 ID               |
| receiver_id  | INTEGER   | FOREIGN KEY | 接收者用户 ID(0 表示群消息) |
| content      | TEXT      | NOT NULL    | 消息内容                    |
| send_time    | TIMESTAMP | NOT NULL    | 发送时间                    |
| read_status  | TINYINT   | DEFAULT 0   | 读取状态(0-未读,1-已读)     |
| message_type | TINYINT   | NOT NULL    | 消息类型(1-文本,2-文件)     |
| file_id      | INTEGER   |             | 关联文件 ID(如果是文件类型) |
| group_id     | INTEGER   |             | 群组 ID(私聊为 NULL)        |

#### 文件表设计

文件表（Files）用于存储系统中上传的所有文件信息：

| 字段名         | 数据类型     | 约束        | 说明           |
| -------------- | ------------ | ----------- | -------------- |
| file_id        | INTEGER      | PRIMARY KEY | 文件唯一标识符 |
| file_name      | VARCHAR(255) | NOT NULL    | 文件原始名称   |
| file_path      | VARCHAR(255) | NOT NULL    | 文件存储路径   |
| file_size      | INTEGER      | NOT NULL    | 文件大小(字节) |
| file_type      | VARCHAR(50)  |             | 文件类型       |
| upload_time    | TIMESTAMP    | NOT NULL    | 上传时间       |
| uploader_id    | INTEGER      | FOREIGN KEY | 上传者用户 ID  |
| download_count | INTEGER      | DEFAULT 0   | 下载次数       |

#### 回帖表设计

回帖表（Replies）用于存储对帖子的回复信息：

| 字段名      | 数据类型  | 约束        | 说明           |
| ----------- | --------- | ----------- | -------------- |
| reply_id    | INTEGER   | PRIMARY KEY | 回复唯一标识符 |
| post_id     | INTEGER   | FOREIGN KEY | 所属帖子 ID    |
| user_id     | INTEGER   | FOREIGN KEY | 回复用户 ID    |
| content     | TEXT      | NOT NULL    | 回复内容       |
| create_time | TIMESTAMP | NOT NULL    | 回复时间       |

#### 用户关系表设计

用户好友关系表（UserRelations）用于存储用户之间的关系：

| 字段名      | 数据类型  | 约束        | 说明           |
| ----------- | --------- | ----------- | -------------- |
| id          | INTEGER   | PRIMARY KEY | 关系唯一标识符 |
| user_id     | INTEGER   | FOREIGN KEY | 用户 ID        |
| related_id  | INTEGER   | FOREIGN KEY | 关联用户 ID    |
| create_time | TIMESTAMP | NOT NULL    | 创建时间       |

### 服务端架构

#### 多线程设计

#### 并发控制

#### 网络接口设计

### 业务逻辑

#### 用户管理

#### BBS 功能实现

#### 即时通讯实现

#### 文件管理

## 编译与部署

### 开发环境

#### 系统要求

#### 依赖库

#### 开发工具

### Makefile 说明

#### all 目标

#### clean 目标

#### install 目标

#### uninstall 目标

### 部署指南

#### 服务器部署

#### 客户端部署

#### 配置文件说明
